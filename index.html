<!DOCTYPE html>
<html lang="bs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VaktijaUSK</title>
<link rel="manifest" href="manifest.json">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  text-align:center;
}
h1{padding:15px 0;margin:0;font-size:28px;}
h2{margin:10px 0;}
#date{font-size:16px;margin-bottom:10px;color:#94a3b8;}
.card{
  background:#1e293b;
  margin:10px 20px;
  padding:15px;
  border-radius:16px;
  font-size:18px;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
}
button{
  padding:10px 20px;
  border:none;
  border-radius:12px;
  background:#22c55e;
  color:white;
  font-size:16px;
  margin:10px;
}
#compass{
  width:200px;
  height:200px;
  margin:20px auto;
  border:4px solid #22c55e;
  border-radius:50%;
  position:relative;
}
#needle{
  width:4px;
  height:90px;
  background:red;
  position:absolute;
  top:10px;
  left:50%;
  transform-origin:bottom;
}
.footer{
  margin:20px;
  font-size:14px;
  color:#94a3b8;
}
</style>
</head>
<body>

<h1>üïå VaktijaUSK</h1>
<div id="date"></div>

<button onclick="getLocation()">üìç Moja lokacija</button>
<button onclick="enableNotifications()">üîî Ukljuƒçi notifikacije</button>

<div id="times"></div>

<h2>üß≠ Qibla</h2>
<div id="compass">
  <div id="needle"></div>
</div>

<div class="footer">
  Dodajte na poƒçetni ekran za offline rad <br>
  by: AmelR.
</div>

<script>
let fajrTime="", dhuhrTime="", asrTime="", maghribTime="", ishaTime="";

function updateDate(){
  const today = new Date();
  const options = {weekday:'long', day:'numeric', month:'long', year:'numeric'};
  document.getElementById("date").textContent = today.toLocaleDateString('bs-BA',options);
}
updateDate();

function getLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      loadTimes(lat,lon);
      calculateQibla(lat,lon);
    });
  } else { alert("GPS nije podr≈æan"); }
}

function loadTimes(lat,lon){
  fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=13`)
  .then(res=>res.json())
  .then(data=>{
    let t=data.data.timings;
    fajrTime = t.Fajr;
    dhuhrTime = t.Dhuhr;
    asrTime = t.Asr;
    maghribTime = t.Maghrib;
    ishaTime = t.Isha;

    document.getElementById("times").innerHTML=`
      <div class="card">Sabah (Fajr): ${t.Fajr}</div>
      <div class="card">Podne (Dhuhr): ${t.Dhuhr}</div>
      <div class="card">Ikindija (Asr): ${t.Asr}</div>
      <div class="card">Ak≈°am (Maghrib): ${t.Maghrib}</div>
      <div class="card">Jacija (Isha): ${t.Isha}</div>
    `;
  });
}

function enableNotifications(){
  Notification.requestPermission().then(permission=>{
    if(permission==="granted"){ scheduleAllPrayers(); }
  });
}

function scheduleAllPrayers(){
  schedulePrayer(fajrTime,"Sabah (Fajr)");
  schedulePrayer(dhuhrTime,"Podne (Dhuhr)");
  schedulePrayer(asrTime,"Ikindija (Asr)");
  schedulePrayer(maghribTime,"Ak≈°am (Maghrib)");
  schedulePrayer(ishaTime,"Jacija (Isha)");
}

function schedulePrayer(vrijeme, ime){
  if(!vrijeme) return;

  const parts = vrijeme.split(":");
  const now = new Date();
  const prayerDate = new Date();
  prayerDate.setHours(parts[0], parts[1], 0);

  // 5 minuta prije
  let timeout = prayerDate - now - (5*60*1000);

  if(timeout < 0) return; // ako je pro≈°lo

  setTimeout(()=>{
    if(Notification.permission === "granted"){
      new Notification(`Vrijeme je za ${ime} üïå`);

      // zvuk notifikacije
      const audio = new Audio("https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3");
      audio.play().catch(err=>{
        console.log("Zvuk nije podr≈æan:", err);
      });
    }
  }, timeout);
}

function calculateQibla(lat,lon){
  const kaabaLat=21.4225*Math.PI/180;
  const kaabaLon=39.8262*Math.PI/180;
  const phi=lat*Math.PI/180;
  const lambda=lon*Math.PI/180;
  const angle=Math.atan2(Math.sin(kaabaLon-lambda),
    Math.cos(phi)*Math.tan(kaabaLat)-Math.sin(phi)*Math.cos(kaabaLon-lambda)
  );
  const deg=angle*180/Math.PI;
  document.getElementById("needle").style.transform=`rotate(${deg}deg)`;
}

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
