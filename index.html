<!DOCTYPE html>
<html lang="bs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VaktijaUSK</title>
<link rel="manifest" href="manifest.json">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  text-align:center;
}

h1{
  padding:15px 0;
  margin:0;
  font-size:28px;
}

#date{
  font-size:16px;
  margin-bottom:15px;
  color:#94a3b8;
}

.card{
  background:#1e293b;
  margin:10px 20px;
  padding:15px;
  border-radius:16px;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
}

.prayer-name{
  font-size:16px;
  font-weight:bold;
  opacity:0.8;
}

.prayer-time{
  font-size:28px;
  font-weight:bold;
  margin-top:5px;
}

button{
  padding:10px 20px;
  border:none;
  border-radius:12px;
  background:#22c55e;
  color:white;
  font-size:16px;
  margin:8px;
}

/* NOVI QIBLA DIZAJN */
#compass{
  width:140px;
  height:140px;
  margin:20px auto;
  border:3px solid #22c55e;
  border-radius:50%;
  position:relative;
  background:radial-gradient(circle,#1e293b 40%, #0f172a 100%);
}

#needle{
  width:4px;
  height:60px;
  background:#ef4444;
  position:absolute;
  top:10px;
  left:50%;
  transform-origin:bottom;
}

.qibla-text{
  font-size:14px;
  margin-top:5px;
  color:#94a3b8;
}

.footer{
  margin:20px;
  font-size:14px;
  color:#94a3b8;
}

.loading{
  margin-top:15px;
  font-size:16px;
  color:#22c55e;
}
</style>
</head>
<body>

<h1>üïå VaktijaUSK</h1>
<div id="date"></div>
<div id="loading" class="loading">Uƒçitavanje lokacije...</div>

<button onclick="getLocation()">üîÑ Osvje≈æi</button>
<button onclick="enableNotifications()">üîî Notifikacije</button>

<div id="times"></div>

<h2>üß≠ Qibla</h2>
<div id="compass">
  <div id="needle"></div>
</div>
<div class="qibla-text">Smjer prema Kabi</div>

<div class="footer">
  Dodajte na poƒçetni ekran za offline rad <br>
  by: AmelR.
</div>

<script>

let fajrTime="", dhuhrTime="", asrTime="", maghribTime="", ishaTime="";

function updateDate(){
  const today = new Date();
  const options = {weekday:'long', day:'numeric', month:'long', year:'numeric'};
  document.getElementById("date").textContent =
      today.toLocaleDateString('bs-BA',options);
}
updateDate();

window.onload = function(){
  getLocation();
};

function getLocation(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      document.getElementById("loading").style.display="none";

      loadTimes(lat,lon);
      calculateQibla(lat,lon);

    }, ()=>{
      document.getElementById("loading").textContent =
        "Dozvolite pristup lokaciji.";
    });
  }
}

function loadTimes(lat,lon){
  fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=13`)
  .then(res=>res.json())
  .then(data=>{
    let t=data.data.timings;

    fajrTime = t.Fajr;
    dhuhrTime = t.Dhuhr;
    asrTime = t.Asr;
    maghribTime = t.Maghrib;
    ishaTime = t.Isha;

    document.getElementById("times").innerHTML=`

      <div class="card">
        <div class="prayer-name">Sabah</div>
        <div class="prayer-time">${t.Fajr}</div>
      </div>

      <div class="card">
        <div class="prayer-name">Podne</div>
        <div class="prayer-time">${t.Dhuhr}</div>
      </div>

      <div class="card">
        <div class="prayer-name">Ikindija</div>
        <div class="prayer-time">${t.Asr}</div>
      </div>

      <div class="card">
        <div class="prayer-name">Ak≈°am</div>
        <div class="prayer-time">${t.Maghrib}</div>
      </div>

      <div class="card">
        <div class="prayer-name">Jacija</div>
        <div class="prayer-time">${t.Isha}</div>
      </div>
    `;
  });
}

function enableNotifications(){
  Notification.requestPermission().then(permission=>{
    if(permission==="granted"){
      scheduleAllPrayers();
      alert("Notifikacije ukljuƒçene ‚úÖ");
    }
  });
}

function scheduleAllPrayers(){
  schedulePrayer(fajrTime,"Sabah");
  schedulePrayer(dhuhrTime,"Podne");
  schedulePrayer(asrTime,"Ikindija");
  schedulePrayer(maghribTime,"Ak≈°am");
  schedulePrayer(ishaTime,"Jacija");
}

function schedulePrayer(vrijeme, ime){
  if(!vrijeme) return;

  const parts = vrijeme.split(":");
  const now = new Date();
  const prayerDate = new Date();
  prayerDate.setHours(parts[0], parts[1], 0);

  let timeout = prayerDate - now - (5*60*1000);
  if(timeout < 0) return;

  setTimeout(()=>{
    if(Notification.permission === "granted"){
      new Notification(`Vrijeme je za ${ime} üïå`);
      const audio = new Audio("https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3");
      audio.play().catch(()=>{});
    }
  }, timeout);
}

function calculateQibla(lat,lon){
  const kaabaLat=21.4225*Math.PI/180;
  const kaabaLon=39.8262*Math.PI/180;
  const phi=lat*Math.PI/180;
  const lambda=lon*Math.PI/180;

  const angle=Math.atan2(
    Math.sin(kaabaLon-lambda),
    Math.cos(phi)*Math.tan(kaabaLat)-
    Math.sin(phi)*Math.cos(kaabaLon-lambda)
  );

  const deg=angle*180/Math.PI;
  document.getElementById("needle").style.transform=`rotate(${deg}deg)`;
}

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}

</script>

</body>
</html>
