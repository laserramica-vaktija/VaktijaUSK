<!DOCTYPE html>
<html lang="bs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaktija USK</title>
<link rel="manifest" href="manifest.json">

<style>
body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    color:white;
    text-align:center;
}

h1{ margin-top:15px; }

#clock{
    font-size:56px;
    font-weight:900;
    margin:5px 0;
}

#nextPrayer{
    font-size:20px;
    font-weight:bold;
    margin-bottom:10px;
}

button{
    padding:10px 20px;
    border:none;
    border-radius:20px;
    background:#00c6ff;
    color:black;
    font-weight:bold;
    cursor:pointer;
    margin-bottom:10px;
}

.namaz-container{
    display:grid;
    grid-template-columns: repeat(2,1fr);
    gap:15px;
    padding:15px;
}

.namaz{
    background: rgba(255,255,255,0.1);
    border-radius:15px;
    padding:15px;
    backdrop-filter: blur(5px);
}

.namaz h3{
    margin:0;
    font-size:20px;
}

.namaz p{
    margin-top:8px;
    font-size:24px;
    font-weight:bold;
}

.highlight{
    background:#00c6ff;
    color:black;
}

#qibla{
    margin-top:20px;
}

#compass{
    width:100px;
    height:100px;
    border:3px solid white;
    border-radius:50%;
    margin:auto;
    position:relative;
}

#needle{
    width:4px;
    height:45px;
    background:red;
    position:absolute;
    top:15px;
    left:50%;
    transform-origin: bottom center;
}
</style>
</head>
<body>

<h1>üïå Vaktija USK</h1>

<div id="clock"></div>
<div id="nextPrayer"></div>

<button onclick="enableNotifications()">üîî Ukljuƒçi notifikacije</button>

<div class="namaz-container" id="namazi"></div>

<div id="qibla">
<h3>Kibla</h3>
<div id="compass">
<div id="needle"></div>
</div>
</div>

<script>
let prayerTimes = {};
let prayerOrder = ["Fajr","Dhuhr","Asr","Maghrib","Isha"];
let prayerNames = {
    "Fajr":"Sabah",
    "Dhuhr":"Podne",
    "Asr":"Ikindija",
    "Maghrib":"Ak≈°am",
    "Isha":"Jacija"
};

function updateClock(){
    document.getElementById("clock").innerHTML =
        new Date().toLocaleTimeString("bs-BA");
}
setInterval(updateClock,1000);
updateClock();

function enableNotifications(){
    Notification.requestPermission().then(permission=>{
        if(permission === "granted"){
            alert("Notifikacije ukljuƒçene ‚úÖ");
        }
    });
}

function schedulePrayer(vrijeme, ime){
    if(!vrijeme) return;
    const parts = vrijeme.split(":");
    const now = new Date();
    const prayerDate = new Date();
    prayerDate.setHours(parts[0], parts[1], 0);
    let timeout = prayerDate - now - (5*60*1000);
    if(timeout < 0) return;

    setTimeout(()=>{
        if(Notification.permission === "granted"){
            new Notification("üïå Vrijeme je za " + ime);
        }
        const audio = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
        audio.play().catch(()=>{});
    }, timeout);
}

function getNextPrayer(){
    const now = new Date();
    for(let key of prayerOrder){
        const parts = prayerTimes[key].split(":");
        const prayerDate = new Date();
        prayerDate.setHours(parts[0], parts[1], 0);
        if(prayerDate > now){
            document.getElementById("nextPrayer").innerHTML =
                "Sljedeƒái namaz: " + prayerNames[key] + " u " + prayerTimes[key];
            return key;
        }
    }
    document.getElementById("nextPrayer").innerHTML = "Sljedeƒái namaz: Sabah sutra";
}

function showNamazi(times){
    const container = document.getElementById("namazi");
    container.innerHTML="";
    const next = getNextPrayer();
    for(let key of prayerOrder){
        const div = document.createElement("div");
        div.className="namaz";
        if(key === next) div.classList.add("highlight");
        div.innerHTML = `<h3>${prayerNames[key]}</h3><p>${times[key]}</p>`;
        container.appendChild(div);
        schedulePrayer(times[key], prayerNames[key]);
    }
}

function fetchTimes(lat,lon){
    fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=13`)
    .then(res=>res.json())
    .then(data=>{
        prayerTimes = data.data.timings;
        localStorage.setItem("prayerTimes", JSON.stringify(prayerTimes));
        showNamazi(prayerTimes);
    })
    .catch(()=>{
        const saved = localStorage.getItem("prayerTimes");
        if(saved){
            prayerTimes = JSON.parse(saved);
            showNamazi(prayerTimes);
        }
    });
}

function getLocation(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            fetchTimes(pos.coords.latitude,pos.coords.longitude);
        },()=>{loadOffline();});
    } else {
        loadOffline();
    }
}

function loadOffline(){
    const saved = localStorage.getItem("prayerTimes");
    if(saved){
        prayerTimes = JSON.parse(saved);
        showNamazi(prayerTimes);
    }
}

getLocation();

if("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js");
}

</script>

</body>
</html>
